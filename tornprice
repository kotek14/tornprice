#!/usr/bin/python
import requests
import os.path
import sys
from ast import literal_eval

api_key = "INSERT YOUR KEY HERE"

def sort_and_present(prices):
	prices.sort()
	i = 0
	while prices[i] and i <= 20:
		print(prices[i])
		i += 1 

def itemupdate():
	r = requests.get("https://api.torn.com/torn/?selections=items&key=" + api_key)
	cache = open("tornitems.kot", "w+")
	cache.write(str(r.json()))
	cache.close()
	
def itemload():
	if os.path.exists("tornitems.kot"):
		cache = open("tornitems.kot", "r")
		data = literal_eval(cache.read())
		cache.close()
		return(data)
	else:
		itemupdate()
		print("Item list updated.")
		return(itemload())

def getprices(item_id):
	p = requests.get("https://api.torn.com/market/" + str(item_id) + "?selections=bazaar,itemmarket&key=" + api_key)
	prices = p.json()
	all_prices = []
	for seller in prices['bazaar']:
		all_prices.append(prices['bazaar'][seller]['cost'])
	for seller in prices['itemmarket']:
		all_prices.append(prices['itemmarket'][seller]['cost'])
	sort_and_present(all_prices)
	
if len(sys.argv) >= 2:
	prices = getprices(sys.argv[1])
	print(prices)
else:
	data = itemload()
	itemname = raw_input("Name? ")
	for itemid in data["items"]:
		if data["items"][str(itemid)]["name"] == itemname:
			getprices(itemid)
			exit(0)
